# Maintainer: Alexey Pavlov <alexpux@gmail.com>
# Contributor: Ray Donnelly <mingw.android@gmail.com>

_realname=cyrus-sasl
pkgname=("${MINGW_PACKAGE_PREFIX}-cyrus-sasl"
         "${MINGW_PACKAGE_PREFIX}-libsasl"
         "${MINGW_PACKAGE_PREFIX}-libsasl-devel")
pkgver=2.1.26
pkgrel=1
pkgdesc="Cyrus Simple Authentication Service Layer (SASL) library"
arch=('any')
url="http://cyrusimap.web.cmu.edu/"
license=('custom')
groups=('sys-utils')
#makedepends=('heimdal-devel' 'openssl-devel' 'libsqlite-devel' 'libcrypt-devel')
depends=("${MINGW_PACKAGE_PREFIX}-dlfcn-svn")
options=('emptydirs' 'strip' '!makeflags')
source=(http://cyrusimap.org/releases/cyrus-sasl-${pkgver}.tar.gz
        01-no-undefined.patch
        02-exeext.patch
        03-fix-plugins.patch
        04-manpage-paths.patch
        05-remove-warnings.patch
        06-fix-sqlite-search.patch
        07-fix-pkgconfig.patch
        08-cyrus-sasl-2.1.26-size_t.patch
        09-cyrus-sasl-2.1.26-msys2.patch
        10-MinGW-w64-already-has-getopt.patch
        11-MinGW-w64-add-disable-win32-reg-option.patch
        12-MinGW-w64-uses-ws2_32-not-socket.patch
        13-MSYS2-Use-cp-f-instead-of-ln-s.patch
        14-MinGW-w64-add-LIBSASL_API-to-function-definitions.patch
        15-MinGW-w64-define-LIBSASL_EXPORTS_eq_1-for-sasldb.patch)
md5sums=('a7f4e5e559a0e37b3ffc438c9456e425'
         '7f52862a74ada70ed2e257990f9b4334'
         'd7ff8a6d1902478190c705a580b4bd80'
         '744e8af08823097021e6087c8baca9c8'
         'abda82e2cb8dca0ebe2fbe9d076c379a'
         '0554b3a77561214126974d63522eb314'
         '5b2af6369c98a778b82b53dee65789ca'
         '716c142e9779dd087ce231345adec0c2'
         'bcaafcbc79054e8356217213d6eda16d'
         'b48df2818c4836801445d9dee0adfaa0'
         '8de468f0d65af91b4a59a52cbe74f11f'
         '13a054e6fc1eccf0a23f9fafaa9b7ec0'
         'dfdac9a7a238d19e90cfcc752110bffd'
         '25310ed758dd501396bea202260cb6e4'
         'db215ba4c3dc94c99284a370cd0fa556'
         'da0368eb0369a62b74e7e1c60db5fdb4')

prepare() {
  cd ${srcdir}/$_realname-$pkgver

  patch -p1 -i ${srcdir}/01-no-undefined.patch
  patch -p1 -i ${srcdir}/02-exeext.patch
  patch -p1 -i ${srcdir}/03-fix-plugins.patch
  patch -p1 -i ${srcdir}/04-manpage-paths.patch
  patch -p1 -i ${srcdir}/05-remove-warnings.patch
  patch -p1 -i ${srcdir}/06-fix-sqlite-search.patch
  patch -p2 -i ${srcdir}/07-fix-pkgconfig.patch
  patch -p1 -i ${srcdir}/08-cyrus-sasl-2.1.26-size_t.patch
  patch -p1 -i ${srcdir}/09-cyrus-sasl-2.1.26-msys2.patch
  patch -p1 -i ${srcdir}/10-MinGW-w64-already-has-getopt.patch
  patch -p1 -i ${srcdir}/11-MinGW-w64-add-disable-win32-reg-option.patch
  patch -p1 -i ${srcdir}/12-MinGW-w64-uses-ws2_32-not-socket.patch
  patch -p1 -i ${srcdir}/13-MSYS2-Use-cp-f-instead-of-ln-s.patch
  patch -p1 -i ${srcdir}/14-MinGW-w64-add-LIBSASL_API-to-function-definitions.patch
  patch -p1 -i ${srcdir}/15-MinGW-w64-define-LIBSASL_EXPORTS_eq_1-for-sasldb.patch

  sed 's/AM_CONFIG_HEADER/AC_CONFIG_HEADERS/' -i configure.in
  rm -f config/config.guess config/config.sub 
  rm -f config/ltconfig config/ltmain.sh config/libtool.m4
  rm -fr autom4te.cache
  libtoolize -c
  aclocal -I config -I cmulocal
  automake -a -c
  autoheader
  autoconf
  
  pushd saslauthd
    rm -f config/config.guess config/config.sub 
    rm -f config/ltconfig config/ltmain.sh config/libtool.m4
    rm -fr autom4te.cache
    libtoolize -c
    aclocal -I config -I ../cmulocal -I ../config
    automake -a -c
    autoheader
    autoconf
  popd
}

build() {
  local _plugindir=${MINGW_PREFIX}/lib/sasl2
  cd ${srcdir}/$_realname-$pkgver
  # Useful ref:
  # https://fedorapeople.org/cgit/elmarco/public_git/mingw32-cyrus-sasl.git/tree/mingw32-cyrus-sasl.spec
  # --oldincludedir=${MINGW_PREFIX}/include is so that /usr/include isn't added by default.
  # --enable-sql seems to have problems with <mysql.h> not existing, I thought it would be a part of sqlite.
  # --enable-sql

  ./configure \
    --prefix=${MINGW_PREFIX} \
    --build=$CHOST \
    --host=$CHOST \
    --with-configdir=${MINGW_PREFIX}/etc/sasl2:${MINGW_PREFIX}/etc/sasl:${MINGW_PREFIX}/lib/sasl2 \
    --with-plugindir=${_plugindir} \
    --disable-static --enable-shared \
    --with-sqlite3=${MINGW_PREFIX} \
    --disable-ldapdb \
    --disable-win32-reg \
    --oldincludedir=${MINGW_PREFIX}/include \
    --without-saslauthd --without-pwcheck \
    --without-authdaemond \
    --with-dblib=gdbm \
    sasl_cv_dlsym_adds_uscore=no

  make CFLAGS="$CFLAGS -Wall -Wno-char-subscripts \
               -Wno-unused -Wno-pointer-sign -Wno-uninitialized \
                -D_POSIX \
               -DS_IRUSR=_S_IREAD -DS_IWUSR=_S_IWRITE -DWIN32_LEAN_AND_MEAN" \
       LDFLAGS="$LDFLAGS -lws2_32 -ldl" \
       sasldir=${_plugindir}
}

package_cyrus-sasl() {
  depends=("libsasl=${pkgver}")
  pkgdesc="Cyrus saslauthd SASL authentication daemon"
  #backup=('etc/conf.d/saslauthd')

  cd $_realname-$pkgver/saslauthd
  make DESTDIR="${pkgdir}" install

  install -m755 -d "${pkgdir}/${MINGW_PREFIX}/share/licenses/cyrus-sasl"
  cp -pR ../COPYING "${pkgdir}${MINGW_PREFIX}/share/licenses/cyrus-sasl/"
}

package_libsasl() {
  groups=('libraries')
  options=('emptydirs' 'strip' 'libtool')
  pkgdesc="Cyrus Simple Authentication Service Layer (SASL) Library"
  depends=('libcrypt'
           'libopenssl'
           'heimdal-libs'
           'libsqlite'
           "${MINGW_PACKAGE_PREFIX}-dlfcn-svn")
  local _plugindir=${MINGW_PREFIX}/lib/sasl2

  cd cyrus-sasl-$pkgver
  for dir in include lib sasldb plugins utils; do
    pushd ${dir}
    make DESTDIR="${pkgdir}" install sasldir=${_plugindir}
    popd
  done
  rm -f "${pkgdir}"/${MINGW_PREFIX}/lib/sasl2/*.a
  rm -f "${pkgdir}"/${MINGW_PREFIX}/lib/*.a
  rm -f "${pkgdir}"/${MINGW_PREFIX}/lib/*.la
  rm -rf "${pkgdir}"/${MINGW_PREFIX}/include
  install -m755 -d "${pkgdir}/${MINGW_PREFIX}/share/licenses/libsasl"
  install -m644 COPYING "${pkgdir}/${MINGW_PREFIX}/share/licenses/libsasl/"
  # pushd "${pkgdir}"/${MINGW_PREFIX}/lib/sasl2
    # for x in .dll; do
      # mv $x $(echo $x | sed e 's/^msys-/lib/' e 's/[0-9][0-9]\.dll$/.so/')
    # done
  # popd
}

package_libsasl-devel() {
  pkgdesc="Libsasl headers and libraries"
  groups=('development')
  depends=("libsasl=${pkgver}" 'heimdal-devel' 'openssl-devel' 'libsqlite-devel' 'libcrypt-devel')
  options=('strip' 'libtool')
  local _plugindir=${MINGW_PREFIX}/lib/sasl2

  cd $_realname-$pkgver
  for dir in include lib; do
    pushd ${dir}
    make DESTDIR="${pkgdir}" install sasldir=${_plugindir}
    popd
  done
  rm -rf "${pkgdir}"/${MINGW_PREFIX}/bin
}

package_mingw-w64-x86_64-cyrus-sasl() {
  package_cyrus-sasl
}

package_mingw-w64-i686-cyrus-sasl() {
  package_cyrus-sasl
}

package_mingw-w64-x86_64-libsasl() {
  package_libsasl
}

package_mingw-w64-i686-libsasl() {
  package_libsasl
}

package_mingw-w64-x86_64-libsasl-devel() {
  package_libsasl-devel
}

package_mingw-w64-i686-libsasl-devel() {
  package_libsasl-devel
}

# /e/m2/repo/mingw-w64-cyrus-sasl/src/cyrus-sasl-2.1.26/sasldb
# LIBSASL_API is defined 


# Since allockey in libsasldb.a has undefined reference to `__imp__sasldb_getkeyhandle' it must've included prop.h without
# LIBSASL_EXPORTS defined (which makes sense).
# ../sasldb/.libs/libsasldb.a(allockey.o):allockey.c:(.text+0x45b): undefined reference to `__imp__sasldb_getkeyhandle'
# ../sasldb/.libs/libsasldb.a(allockey.o):allockey.c:(.text+0x470): undefined reference to `__imp__sasldb_getnextkey'
# ../sasldb/.libs/libsasldb.a(allockey.o):allockey.c:(.text+0x572): undefined reference to `__imp__sasldb_releasekeyhandle'
# /bin/sh ../libtool --tag=CC   --mode=compile x86_64-w64-mingw32-gcc -DHAVE_CONFIG_H -I. -I.. -I../include -I../include   -D_FORTIFY_SOURCE=2 -D__USE_MINGW_ANSI_STDIO=1 -DOBSOLETE_CRAM_ATTR=1 -I/mingw64/include  -march=x86-64 -mtune=generic -O2 -pipe -Wall -Wno-char-subscripts                -Wno-unused -Wno-pointer-sign -Wno-uninitialized                 -D_POSIX                -DS_IRUSR=_S_IREAD -DS_IWUSR=_S_IWRITE -DWIN32_LEAN_AND_MEAN -MT allockey.lo -MD -MP -MF .deps/allockey.Tpo -c -o allockey.lo allockey.c
# .. an import library must have been made containing these names and a DLL must exist with the non-import name:
# .. but there's no DLLs, but there is a ./src/cyrus-sasl-2.1.26/plugins/.libs/libsasldb.dll.a
# libtool: link: x86_64-w64-mingw32-gcc -shared  .libs/sasldb.o .libs/sasldb_init.o .libs/plugin_common.o .libs/getaddrinfo.o .libs/getnameinfo.o  -Wl,--whole-archive ../sasldb/.libs/libsasldb.a -Wl,--no-whole-archive  -lws2_32 -ldl -lgdbm  -march=x86-64 -mtune=generic -O2   -o .libs/libsasldb-3.dll -Wl,--enable-auto-image-base -Xlinker --out-implib -Xlinker .libs/libsasldb.dll.a

# MinGW-w64:
# pushd /c/repo/mingw-w64-cyrus-sasl/src/cyrus-sasl-2.1.26/sasldb
# PATH=/mingw64/bin:"$PATH" x86_64-w64-mingw32-gcc -DHAVE_CONFIG_H -I. -I.. -I../include -I../include -D_FORTIFY_SOURCE=2 -D__USE_MINGW_ANSI_STDIO=1 -DOBSOLETE_CRAM_ATTR=1 -I/mingw64/include -march=x86-64 -mtune=generic -O2 -pipe -Wall -Wno-char-subscripts -Wno-unused -Wno-pointer-sign -Wno-uninitialized -D_POSIX -DS_IRUSR=_S_IREAD -DS_IWUSR=_S_IWRITE -DWIN32_LEAN_AND_MEAN -MT allockey.lo -MD -MP -MF .deps/allockey.Tpo -c allockey.c  -DDLL_EXPORT -DPIC -o .libs/allockey.o

# MSYS2:
# pushd /c/repo-MSYS2/cyrus-sasl/src/cyrus-sasl-2.1.26/sasldb
# x86_64-pc-msys-gcc -DHAVE_CONFIG_H -I. -I.. -I../include -I../include -D_FORTIFY_SOURCE=2 -DOBSOLETE_CRAM_ATTR=1 -DKRB5_HEIMDAL -I/usr/include -march=x86-64 -mtune=generic -O2 -pipe -Wall -Wno-char-subscripts -Wno-unused -Wno-pointer-sign -Wno-uninitialized -MT allockey.lo -MD -MP -MF .deps/allockey.Tpo -c allockey.c  -DDLL_EXPORT -DPIC -o .libs/allockey.o
