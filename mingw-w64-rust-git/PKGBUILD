# Maintainer: Ray Donnelly <mingw.android@gmail.com>

_realname=rust

pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=r31823.b516532
pkgrel=1
pkgdesc="A safe, concurrent, practical language from Mozilla (mingw-w64)"
arch=('any')
url="http://www.rust-lang.org/"
license=('custom:MIT' 'Apache')
#depends=('shared-mime-info')
makedepends=('git'
      "${MINGW_PACKAGE_PREFIX}-gcc"
      "${MINGW_PACKAGE_PREFIX}-llvm"
      'curl'
      "${MINGW_PACKAGE_PREFIX}-libffi"
      'python2'
      )
options=('!makeflags' 'staticlibs')
#install=rust.install
source=("${_realname}"::"git+https://github.com/mozilla/rust.git")
md5sums=('SKIP')
pkgver() {
  cd "$srcdir"/$_realname
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}
prepare() {
  cd ${srcdir}/${_realname}
}

build() {
  mkdir -p "${srcdir}"/build-${MINGW_CARCH}
  #export CFG_LLVM_ROOT=${MINGW_PREFIX}
  cd "${srcdir}"/build-${MINGW_CARCH}
    ../${_realname}/configure \
    --prefix=${MINGW_PREFIX} \
    --build=${MINGW_CHOST} \
    --host=${MINGW_CHOST} \
    --target=${MINGW_CHOST} \
    --llvm-root=${MINGW_PREFIX}
    
    #--enable-local-rust              use an installed rustc rather than downloading a snapshot
    #--local-rust-root=[/usr/local]   set prefix for local rust binary
    #--enable-clang                   prefer clang to gcc for building the runtime

    make VERBOSE=1
}

package() {
    cd "${srcdir}"/build-${MINGW_CARCH}
    make DESTDIR=${pkgdir} install
}

# pushd /e/m2/repo/mingw-w64-rust-git/src/build-
# CFG_SRC_DIR=/e/m2/repo/mingw-w64-rust-git/src/rust/ /mingw64/bin/python2.7 /e/m2/repo/mingw-w64-rust-git/src/rust/src/etc/get-snapshot.py x86_64-w64-mingw32
# ..
# rm -f dl/* ; /usr/bin/curl -o dl/rust-stage0-2014-08-17-a86d9ad-winnt-i386-c2b08d721c5c1628aea4932c0e09e5bf07d54881.tar.bz2.tmp https://static.rust-lang.org/stage0-snapshots/rust-stage0-2014-08-17-a86d9ad-winnt-i386-c2b08d721c5c1628aea4932c0e09e5bf07d54881.tar.bz2
# vs
# rm -f dl/* ; /e/msys64/mingw64/bin/curl.exe -o dl/rust-stage0-2014-08-17-a86d9ad-winnt-i386-c2b08d721c5c1628aea4932c0e09e5bf07d54881.tar.bz2.tmp https://static.rust-lang.org/stage0-snapshots/rust-stage0-2014-08-17-a86d9ad-winnt-i386-c2b08d721c5c1628aea4932c0e09e5bf07d54881.tar.bz2
#
