From a2b3d4b16819c15c9f8860e61f2b9db0da6e516e Mon Sep 17 00:00:00 2001
From: Roumen Petrov <local@example.net>
Date: Sat, 9 Mar 2013 14:11:52 +0200
Subject: [PATCH 14/24] MINGW: setup msvcrt and _winapi modules

---
 Modules/_winapi.c |  2 ++
 PC/msvcrtmodule.c |  2 ++
 setup.py          | 10 ++++++++++
 3 files changed, 14 insertions(+)

diff --git a/Modules/_winapi.c b/Modules/_winapi.c
index c34d2db..8132cbe 100644
--- a/Modules/_winapi.c
+++ b/Modules/_winapi.c
@@ -39,7 +39,9 @@
 
 #define WINDOWS_LEAN_AND_MEAN
 #include "windows.h"
+#if defined(Py_DEBUG)
 #include <crtdbg.h>
+#endif
 
 #if defined(MS_WIN32) && !defined(MS_WIN64)
 #define HANDLE_TO_PYNUM(handle) \
diff --git a/PC/msvcrtmodule.c b/PC/msvcrtmodule.c
index 18dec6d..1426226 100755
--- a/PC/msvcrtmodule.c
+++ b/PC/msvcrtmodule.c
@@ -21,7 +21,9 @@
 #include <io.h>
 #include <conio.h>
 #include <sys/locking.h>
+#ifdef _DEBUG
 #include <crtdbg.h>
+#endif
 #include <windows.h>
 
 #ifdef _MSC_VER
diff --git a/setup.py b/setup.py
index 5ab4f41..20eb135 100644
--- a/setup.py
+++ b/setup.py
@@ -882,6 +882,16 @@ class PyBuildExt(build_ext):
         min_db_ver = (3, 3)
         db_setup_debug = False   # verbose debug prints from this script?
 
+        # Modules with some Windows dependencies:
+        if host_platform.startswith(('mingw', 'win')):
+            srcdir = sysconfig.get_config_var('srcdir')
+            pc_srcdir = os.path.abspath(os.path.join(srcdir, 'PC'))
+
+            exts.append( Extension('msvcrt', [os.path.join(pc_srcdir, p)
+                for p in ['msvcrtmodule.c']]) )
+
+            exts.append( Extension('_winapi', ['_winapi.c']) )
+
         def allow_db_ver(db_ver):
             """Returns a boolean if the given BerkeleyDB version is acceptable.
 
-- 
1.7.12.1
