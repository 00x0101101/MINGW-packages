From 45b187daf9b25ec0f91e53617b75ea72139c3b20 Mon Sep 17 00:00:00 2001
From: Roumen Petrov <local@example.net>
Date: Sat, 2 Mar 2013 12:41:26 +0200
Subject: [PATCH 10/24] MINGW: setup select module

---
 Modules/selectmodule.c | 6 +++---
 setup.py               | 6 +++++-
 2 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/Modules/selectmodule.c b/Modules/selectmodule.c
index 252dee2..cc54258 100644
--- a/Modules/selectmodule.c
+++ b/Modules/selectmodule.c
@@ -106,9 +106,9 @@ seq2set(PyObject *seq, fd_set *set, pylist fd2obj[FD_SETSIZE + 1])
         v = PyObject_AsFileDescriptor( o );
         if (v == -1) goto finally;
 
-#if defined(_MSC_VER)
+#if defined(MS_WIN32)
         max = 0;                             /* not used for Win32 */
-#else  /* !_MSC_VER */
+#else  /* !MS_WIN32 */
         if (!_PyIsSelectable_fd(v)) {
             PyErr_SetString(PyExc_ValueError,
                         "filedescriptor out of range in select()");
@@ -116,7 +116,7 @@ seq2set(PyObject *seq, fd_set *set, pylist fd2obj[FD_SETSIZE + 1])
         }
         if (v > max)
             max = v;
-#endif /* _MSC_VER */
+#endif /* MS_WIN32 */
         FD_SET(v, set);
 
         /* add object and its file descriptor to the list */
diff --git a/setup.py b/setup.py
index fe3c215..c95c5f6 100644
--- a/setup.py
+++ b/setup.py
@@ -622,7 +622,11 @@ class PyBuildExt(build_ext):
             missing.append('spwd')
 
         # select(2); not on ancient System V
-        exts.append( Extension('select', ['selectmodule.c']) )
+        select_libs = []
+        if host_platform.startswith(('mingw', 'win')):
+            select_libs += ['ws2_32']
+        exts.append( Extension('select', ['selectmodule.c'],
+                               libraries=select_libs) )
 
         # Fred Drake's interface to the Python parser
         exts.append( Extension('parser', ['parsermodule.c']) )
-- 
1.7.12.1
