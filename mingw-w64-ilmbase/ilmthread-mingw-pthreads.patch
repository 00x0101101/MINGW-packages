--- ilmbase-2.1.0.orig/m4/threads.m4	2014-01-14 11:49:39.595596500 +0000
+++ ilmbase-2.1.0/m4/threads.m4	2014-01-14 11:50:14.780609000 +0000
@@ -254,11 +254,11 @@
 if test "${enable_posix_sem:-yes}" != "no"; then
     AC_CHECK_HEADERS([semaphore.h], [
 	AC_SEARCH_LIBS(sem_init, [posix4 pthread], [
-	    AC_MSG_CHECKING([whether to use POSIX unnamed semaphores])
+	    AC_MSG_CHECKING([whether to use POSIX unnamed semaphores (pshared=0)])
 	    AC_RUN_IFELSE([
 		AC_LANG_PROGRAM([#include <semaphore.h>], [
 		    sem_t mysem;
-		    if (sem_init (&mysem, 1, 1) == 0)
+		    if (sem_init (&mysem, 0, 1) == 0)
 		    {
 			if (sem_wait (&mysem) == 0)
 			{
diff -urN ilmbase-2.1.0.orig/IlmThread/IlmThread.h src/ilmbase-2.1.0/IlmThread/IlmThread.h
--- ilmbase-2.1.0.orig/IlmThread/IlmThread.h	2014-01-14 11:49:39.546593700 +0000
+++ src/ilmbase-2.1.0/IlmThread/IlmThread.h	2014-01-14 12:06:33.615505800 +0000
@@ -94,7 +94,7 @@
 #include "IlmThreadExport.h"
 #include "IlmThreadNamespace.h"
 
-#if defined _WIN32 || defined _WIN64
+#if (defined _WIN32 || defined _WIN64) && !defined HAVE_PTHREAD
     #ifdef NOMINMAX
         #undef NOMINMAX
     #endif
@@ -127,7 +127,7 @@
     
   private:
 
-    #if defined _WIN32 || defined _WIN64
+    #if (defined _WIN32 || defined _WIN64) && !defined HAVE_PTHREAD
 	HANDLE _thread;
     #elif HAVE_PTHREAD
 	pthread_t _thread;
diff -urN ilmbase-2.1.0.orig/IlmThread/IlmThreadSemaphore.h ilmbase-2.1.0/IlmThread/IlmThreadSemaphore.h
--- ilmbase-2.1.0.orig/IlmThread/IlmThreadSemaphore.h	2014-01-14 10:33:27.793104400 +0000
+++ ilmbase-2.1.0/IlmThread/IlmThreadSemaphore.h	2014-01-14 11:39:36.641109500 +0000
@@ -46,7 +46,7 @@
 #include "IlmThreadExport.h"
 #include "IlmThreadNamespace.h"
 
-#if defined _WIN32 || defined _WIN64
+#if (defined _WIN32 || defined _WIN64) && !defined HAVE_PTHREAD
     #ifdef NOMINMAX
         #undef NOMINMAX
     #endif
@@ -75,7 +75,7 @@
 
   private:
 
-    #if defined _WIN32 || defined _WIN64
+    #if (defined _WIN32 || defined _WIN64) && !defined HAVE_PTHREAD
 
 	mutable HANDLE _semaphore;
 
diff -urN ilmbase-2.1.0.orig/IlmThread/IlmThreadMutex.h src/ilmbase-2.1.0/IlmThread/IlmThreadMutex.h
--- ilmbase-2.1.0.orig/IlmThread/IlmThreadMutex.h	2014-01-14 11:49:39.548593800 +0000
+++ src/ilmbase-2.1.0/IlmThread/IlmThreadMutex.h	2014-01-14 12:12:36.550539000 +0000
@@ -70,7 +70,7 @@
 #include "IlmBaseConfig.h"
 #include "IlmThreadNamespace.h"
 
-#if defined _WIN32 || defined _WIN64
+#if (defined _WIN32 || defined _WIN64) && !defined HAVE_PTHREAD
     #ifdef NOMINMAX
         #undef NOMINMAX
     #endif
@@ -97,7 +97,7 @@
     void	lock () const;
     void	unlock () const;
 
-    #if defined _WIN32 || defined _WIN64
+    #if (defined _WIN32 || defined _WIN64) && !defined HAVE_PTHREAD
 	mutable CRITICAL_SECTION _mutex;
     #elif HAVE_PTHREAD
 	mutable pthread_mutex_t _mutex;
