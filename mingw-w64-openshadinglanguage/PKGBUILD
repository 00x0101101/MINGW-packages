# Maintainer: Alexey Pavlov <alexpux@gmail.com>

_realname=openshadinglanguage
_mingw_suff=mingw-w64-${CARCH}
pkgname="${_mingw_suff}-${_realname}"
pkgver=1.4.1
pkgrel=1
pkgdesc="Advanced shading language for production GI renderers (mingw-w64)"
arch=('any')
url="https://github.com/imageworks/OpenShadingLanguage/"
license=("custom")
depends=("${_mingw_suff}-openexr"
		"${_mingw_suff}-boost"
		"${_mingw_suff}-libpng" 
		"${_mingw_suff}-glew"
		"${_mingw_suff}-libtiff"
		"${_mingw_suff}-openimageio"
		"${_mingw_suff}-freetype"
		#"${_mingw_suff}-intel-tbb"
		"${_mingw_suff}-llvm=3.3"
		"${_mingw_suff}-ilmbase"
		"${_mingw_suff}-openexr"
		)
makedepends=("${_mingw_suff}-cmake" "${_mingw_suff}-clang=3.3" "${_mingw_suff}-gcc")
source=(https://github.com/imageworks/OpenShadingLanguage/archive/Release-${pkgver}.tar.gz
		0001-mingw-w64-fix.patch
		0002-dont-add-flex-include-dir.patch
		0003-fix-OIIO-windows-and-remove-unused-var.patch
		0004-use-find_package-for-LLVM.patch
		0100-llvm32.patch)
md5sums=('653da56205360a668a6f71637b00a4c1'
         'c225e66cd0a59a674b331b26374ba082'
         '78526dd22cea1d42238609a9cdfef816'
         '088a091907a4880432ccdfe73f79ed9f'
         '87fb9dd7fc41c24162eabf67307f8662'
         '3147f26453b28a971688ab6e54933449')

prepare() {
  cd ${srcdir}/OpenShadingLanguage-Release-$pkgver
  patch -p1 -i ${srcdir}/0001-mingw-w64-fix.patch
  patch -p1 -i ${srcdir}/0002-dont-add-flex-include-dir.patch
  patch -p1 -i ${srcdir}/0003-fix-OIIO-windows-and-remove-unused-var.patch
  patch -p1 -i ${srcdir}/0004-use-find_package-for-LLVM.patch
#  patch -p1 -i ${srcdir}/0100-llvm32.patch
}

build() {
	mkdir -p ${pkgdir}${MINGW_PREFIX}
	pushd ${pkgdir}${MINGW_PREFIX} > /dev/null
	export PREFIX_WIN=`pwd -W`
	popd > /dev/null
	
	pushd ${MINGW_PREFIX} > /dev/null
	export PREFIX_DEPS=`pwd -W`
	popd > /dev/null
	
	export OPENIMAGEIOHOME=${MINGW_PREFIX}
	export LLVM_DIRECTORY=${MINGW_PREFIX}
	cd OpenShadingLanguage-Release-$pkgver
	cd src
	[[ -d build ]] && rm -r build
	mkdir build && cd build
    ${MINGW_PREFIX}/bin/cmake.exe \
		-G"MSYS Makefiles" \
		-DCMAKE_INSTALL_PREFIX:PATH=${PREFIX_WIN} \
		-DLLVM_STATIC=1 \
		-DVERBOSE=1 \
		-DCMAKE_CXX_FLAGS="-DTINYFORMAT_ALLOW_WCHAR_STRINGS" \
      ../..
    # PATH addition needed for running oslc.exe during the build (for liboslcomp.dll)
    PATH=$PWD/src/liboslcomp:"${PATH}" make VERBOSE=1
}

package() {
  cd OpenShadingLanguage-Release-$pkgver/src/build

  make install

  mkdir -p "$pkgdir"/usr/share/OSL/
  mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
  mv "$pkgdir"/usr/LICENSE "$pkgdir"/usr/share/licenses/$pkgname # TODO: Tell upstream about this shit
  mv "$pkgdir"/usr/{CHANGES,README.md,INSTALL} "$pkgdir"/usr/share/OSL/
  mv "$pkgdir"/usr/doc "$pkgdir"/usr/share/OSL/doc
  mv "$pkgdir"/usr/shaders "$pkgdir"/usr/share/OSL/shadersE
}
