# Maintainer: Alexey Pavlov <alexpux@gmail.com>

_realname=openshadinglanguage
_mingw_suff=mingw-w64-${CARCH}
pkgname="${_mingw_suff}-${_realname}"
pkgver=1.4.0
pkgrel=1
pkgdesc="Advanced shading language for production GI renderers (mingw-w64)"
arch=('any')
url="https://github.com/imageworks/OpenShadingLanguage/"
license=("custom")
depends=("${_mingw_suff}-openexr"
		"${_mingw_suff}-boost"
		"${_mingw_suff}-libpng" 
		"${_mingw_suff}-glew"
		"${_mingw_suff}-libtiff"
		"${_mingw_suff}-openimageio"
		"${_mingw_suff}-freetype"
		#"${_mingw_suff}-intel-tbb"
		"${_mingw_suff}-llvm"
		"${_mingw_suff}-ilmbase"
		"${_mingw_suff}-openexr"
		)
makedepends=("${_mingw_suff}-cmake" "${_mingw_suff}-clang" "${_mingw_suff}-gcc")
source=(https://github.com/imageworks/OpenShadingLanguage/archive/Release-${pkgver}.tar.gz
		0001-mingw-w64-fix.patch
		0002-dont-add-flex-include-dir.patch
		0100-llvm32.patch)
md5sums=('dcc7b6dfbc68d7af0d5cfa2940ff205b'
         'c81aabb3e10ba52963f55854ec0f6ce5'
         'SKIP'
         'SKIP')
prepare() {
  cd ${srcdir}/OpenShadingLanguage-Release-$pkgver
  patch -p0 -i ${srcdir}/0001-mingw-w64-fix.patch
  patch -p2 -i ${srcdir}/0002-dont-add-flex-include-dir.patch
#  patch -p1 -i ${srcdir}/0100-llvm32.patch
}

build() {
	mkdir -p ${pkgdir}${MINGW_PREFIX}
	pushd ${pkgdir}${MINGW_PREFIX} > /dev/null
	export PREFIX_WIN=`pwd -W`
	popd > /dev/null
	
	pushd ${MINGW_PREFIX} > /dev/null
	export PREFIX_DEPS=`pwd -W`
	popd > /dev/null
	
	export OPENIMAGEIOHOME=${MINGW_PREFIX}
	export LLVM_DIRECTORY=${MINGW_PREFIX}
	cd OpenShadingLanguage-Release-$pkgver
	cd src
	[[ -d build ]] && rm -r build
	mkdir build && cd build
    ${MINGW_PREFIX}/bin/cmake.exe \
		-G"MSYS Makefiles" \
		-DCMAKE_INSTALL_PREFIX:PATH=${PREFIX_WIN} \
		-DLLVM_STATIC=1 \
		-DVERBOSE=1 \
		-DCMAKE_CXX_FLAGS="-DTINYFORMAT_ALLOW_WCHAR_STRINGS" \
      ../..
    make
}

package() {
  cd OpenShadingLanguage-Release-$pkgver/src/build

  make install

  mkdir -p "$pkgdir"/usr/share/OSL/
  mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
  mv "$pkgdir"/usr/LICENSE "$pkgdir"/usr/share/licenses/$pkgname # TODO: Tell upstream about this shit
  mv "$pkgdir"/usr/{CHANGES,README.md,INSTALL} "$pkgdir"/usr/share/OSL/
  mv "$pkgdir"/usr/doc "$pkgdir"/usr/share/OSL/doc
  mv "$pkgdir"/usr/shaders "$pkgdir"/usr/share/OSL/shadersE
}
