From 62ce49653c8ec2ed53428004efa212e83042e091 Mon Sep 17 00:00:00 2001
From: Martell Malone <martellmalone@gmail.com>
Date: Thu, 25 Jun 2015 23:56:02 +0100
Subject: [PATCH 6/8] import time code from mattn

---
 lib/common/time.c | 25 +++++++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/lib/common/time.c b/lib/common/time.c
index 5308848..6b5e95c 100644
--- a/lib/common/time.c
+++ b/lib/common/time.c
@@ -24,6 +24,26 @@
 #include <string.h>
 #include "h2o/time_.h"
 
+#ifdef _WIN32
+struct tm *
+localtime_r(const time_t *t, struct tm *r) {
+     struct tm *lt = localtime(t);
+     if (lt == NULL || r == NULL)
+         return NULL;
+     memcpy(r, lt, sizeof(struct tm));
+     return r;
+}
+
+struct tm *
+gmtime_r(const time_t *t, struct tm *r) {
+     struct tm *lt = gmtime(t);
+     if (lt == NULL || r == NULL)
+         return NULL;
+     memcpy(r, lt, sizeof(struct tm));
+     return r;
+}
+#endif
+
 static char *emit_wday(char *dst, int wday)
 {
     memcpy(dst, ("SunMonTueWedThuFriSat") + wday * 3, 3);
@@ -139,7 +159,12 @@ void h2o_time2str_log(char *buf, time_t time)
 {
     struct tm localt;
     localtime_r(&time, &localt);
+#ifdef _WIN32
+    extern __declspec(dllimport) long _timezone;
+    int gmt_off = (int)(_timezone / 60);
+#else
     int gmt_off = (int)(localt.tm_gmtoff / 60);
+#endif
     int gmt_sign;
 
     if (gmt_off >= 0) {
-- 
2.4.4

