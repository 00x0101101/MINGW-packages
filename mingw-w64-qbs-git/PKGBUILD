# Maintainer: Alexey Pavlov <alexpux@gmail.com>
# Maintainer: Ray Donnelly <mingw.android@gmail.com>

# Preamble: Because qt5 has:
# qt5/mkspecs/features/win32/windows.prf:10: !contains(QMAKE_DEFAULT_LIBDIRS, $$QT.core.libs):
# qt5/mkspecs/features/win32/windows.prf:10:     QMAKE_LIBS += -L$$QT.core.libs
# and:
# qtbase/qmake/generators/win32/mingw_make.cpp
# << var("QMAKE_LIBS").replace(QRegExp("(\\slib|^lib)")," -l") << ' '
# << var("QMAKE_LIBS_PRIVATE").replace(QRegExp("(\\slib|^lib)")," -l") << endl;
# (or even..):
# qtbase/qmake/generators/unix/unixmake2.cpp
# t << "LIBS          = $(SUBLIBS) " << var("QMAKE_LIBS") << " " << var("QMAKE_LIBS_PRIVATE") << endl;
# .. we end up with "-LC:/msys64/mingw64/lib" appearing before the project's
# libdirs, which means an existing libqbscore1.dll.a in C:/msys64/mingw64/lib
# will get used instead of the one we're building and you'll get link errors
# or binary incompat. issues. Really, Qt shouldn't be adding this folder as
# the linker already looks in its libdir - last - anyway.
# Fixing this in qt5/mkspecs/features/win32/windows.prf may make sense?

_realname=qbs
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}-git"
pkgver=1.3.4.r2393.4492084
pkgrel=1
pkgdesc='Qt Build Suite'
url='http://qt-project.org'
arch=('any')
depends=("${MINGW_PACKAGE_PREFIX}-qt5")
makedepends=('git')
options=('docs' 'staticlibs') # '!strip' 'debug')
provides=("${MINGW_PACKAGE_PREFIX}-qbs")
conflicts=("${MINGW_PACKAGE_PREFIX}-qbs")
QBS_GIT_BRANCH=1.3
# To regenerate the patches:
# git format-patch --suffix=".master.patch" -5
source=("git://gitorious.org/qt-labs/qbs.git#branch=$QBS_GIT_BRANCH"
        "manifest"

        "0001-add-hostosinfo.h-to-installed-headers.master.patch"
        "0002-WIP-Xcode-generator.master.patch"
        "0003-add-generator-header-installs.master.patch"
        "0004-Use-.dll.a-instead-of-.a-for-mingw-import-lib.master.patch"
        "0005-setup-toolchains-Pretend-msys-is-mingw.master.patch"

        "0001-add-hostosinfo.h-to-installed-headers.1.4.patch"
        "0002-WIP-Xcode-generator.1.4.patch"
        "0003-add-generator-header-installs.1.4.patch"
        "0004-Use-.dll.a-instead-of-.a-for-mingw-import-librar.1.4.patch"
        "0005-setup-toolchains-Pretend-msys-is-mingw.1.4.patch"
        "0006-add-commandechomode.h-to-installed-headers.1.4.patch"
        "0007-add-many-files-to-installed-headers.1.4.patch"
        "0008-Disable-QT_NO_CAST_FROM_ASCII-due-to-Xcode-gener.1.4.patch"
        "0009-win32-Don-t-specify-LIBS-Psapi.lib-just-psapi.1.4.patch"
        "0010-Disable-WIP-Xcode-generator.1.4.patch"

        "0001-add-hostosinfo.h-to-installed-headers.1.3.4.patch"
        "0002-WIP-Xcode-generator.1.3.4.patch"
        "0003-add-generator-header-installs.1.3.4.patch"
        "0004-Use-.dll.a-instead-of-.a-for-mingw-import-libr.1.3.4.patch"
        "0005-setup-toolchains-Pretend-msys-is-mingw.1.3.4.patch")

sha256sums=('SKIP'
            '838098b25a8044176b3139b4003594570c62a8d64f5470fbbd769f3bf44e0855'
            '945e0ec9b5d9957a231ac3143339cf3af9767d09b4b923c95dffa25d5672164e'
            '36f638e241737038d41dfa627ecc4de14396aa457ebe4ffd154a0f7776a3cef8'
            '806c64da4c3c8e6ca4b51affe29a02d49fc303a614f34ac08bc62c66f5420ede'
            'b6d35740104f67d241060e2eeb898dee93a1ea3bed3ff3248e29ca60a39b2360'
            '0f55b433f7390106ccb6ab3f057fdb1119eddac2af78baf292a033b402f030b3'
            '9cabead7ee692c5c09d7c8dd6e7b4b6b6ffa830dd256bab45f48a7aaa91d88dc'
            '5d63201aba422aa2d8057dfff1ccefb5506426c9feedc41022f359811d386bdc'
            '2ba9175dd757b44b00ed093759128dae71de2bee4a460c45d47851853bd510f3'
            'fdd98cd9d38e7ae6ed5cffa29140c50a84b7eee789a7f24be6d654f461efa5e5'
            '551036d082f0cb4be0c62718af325e17dc5792fab96a52c7774b98c63b79e7ba'
            'b17b6276ffb1195e7f52c18176b60012e9628f1462e6a379355fb87ae755d509'
            '8ea7c56251f22aeea5ca1bd93632b507547aff65e03ef9f5592508233517d796'
            '83f7950453b2f1b0f082a188ff2e11f1248d04e24f03e15cf2f8287d2be76ca2'
            '70b900686cadd61512f889a2e9c4f0cbe7b36d4744f9eb57e6765cbcdc705c26'
            'ef46ff74aac8aa267a8397d4c02a9481554c45f41748ef8b04ac7ef152d52f22'
            '761d4ff8072600aed4c2cd9b7e0963fc24ddda7ba6bca9431134111432ca6e85'
            '8f6f67ad1036c48efc6604e393d9d0d4c0297391bc86fc4d110995c9c0f4d191'
            'caf5258899ae870d9295079046a699a98a577b18b471d245164456918f95fe4c'
            'e412d4cdd0c0061fdadaada82826b99ada5323bca72a29b2c9f48dabdef0df8c'
            'c126c85ba840426cc9b482119b82a0ec0bc259b9a0496b4d2fadde101bc557ef')

pkgver() {
  cd "$srcdir"/$_realname
  
  local VER_PRI=$(cat qbs_version.pri | sed -n "s/QBS_VERSION = \(.*\)/\1/p")
  printf "%s.r%s.%s" "${VER_PRI}" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "$srcdir"/$_realname
  if [ "${QBS_GIT_BRANCH}" = "master" ]; then
    git am "${srcdir}"/0001-add-hostosinfo.h-to-installed-headers.master.patch
    git am "${srcdir}"/0002-WIP-Xcode-generator.master.patch
    git am "${srcdir}"/0003-add-generator-header-installs.master.patch
    git am "${srcdir}"/0004-Use-.dll.a-instead-of-.a-for-mingw-import-lib.master.patch
    git am "${srcdir}"/0005-setup-toolchains-Pretend-msys-is-mingw.master.patch
  elif [ "${QBS_GIT_BRANCH}" = "1.4" ]; then
    git am "${srcdir}"/0001-add-hostosinfo.h-to-installed-headers.1.4.patch
    git am "${srcdir}"/0002-WIP-Xcode-generator.1.4.patch
    git am "${srcdir}"/0003-add-generator-header-installs.1.4.patch
    git am "${srcdir}"/0004-Use-.dll.a-instead-of-.a-for-mingw-import-librar.1.4.patch
    git am "${srcdir}"/0005-setup-toolchains-Pretend-msys-is-mingw.1.4.patch
    git am "${srcdir}"/0006-add-commandechomode.h-to-installed-headers.1.4.patch
    git am "${srcdir}"/0007-add-many-files-to-installed-headers.1.4.patch
    git am "${srcdir}"/0008-Disable-QT_NO_CAST_FROM_ASCII-due-to-Xcode-gener.1.4.patch
    git am "${srcdir}"/0009-win32-Don-t-specify-LIBS-Psapi.lib-just-psapi.1.4.patch
    git am "${srcdir}"/0010-Disable-WIP-Xcode-generator.1.4.patch
  elif [ "${QBS_GIT_BRANCH}" = "1.3" ]; then
    git am "${srcdir}"/0001-add-hostosinfo.h-to-installed-headers.1.3.4.patch
    git am "${srcdir}"/0002-WIP-Xcode-generator.1.3.4.patch
    git am "${srcdir}"/0003-add-generator-header-installs.1.3.4.patch
    git am "${srcdir}"/0004-Use-.dll.a-instead-of-.a-for-mingw-import-libr.1.3.4.patch
    git am "${srcdir}"/0005-setup-toolchains-Pretend-msys-is-mingw.1.3.4.patch
  fi
}

build() {
local _config
if check_option "debug" "n"; then
  _config="release"
else
  _config="debug"
fi
  cd "$srcdir"/$_realname
  [ -d build-${CARCH} ] && rm -rf build-${CARCH}
  mkdir build-${CARCH}
  cd build-${CARCH}
  ${MINGW_PREFIX}/bin/qmake.exe ../qbs.pro \
    CONFIG+=${_config} \
    CONFIG+=qbs_enable_project_file_updates
  # Because xcodeprojectgenerator has a build order problem.
  make -j1
  make docs
}

package() {
  cd ${srcdir}/${_realname}/build-${CARCH}
  make INSTALL_ROOT=${pkgdir}${MINGW_PREFIX} install
  make INSTALL_ROOT=${pkgdir}${MINGW_PREFIX} install_docs

  rm -f ${pkgdir}${MINGW_PREFIX}/lib/*.dll

  for file in qbs-setup-madde-platforms qbs-setup-qt; do
    cp ${srcdir}/manifest ${pkgdir}${MINGW_PREFIX}/bin/${file}.exe.manifest
  done
}

