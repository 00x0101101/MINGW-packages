From f49c52ac2a36acebbd28cb363108ef1268bc6925 Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Mon, 21 Jul 2014 21:33:08 +0100
Subject: [PATCH 5/5] Also look in winsock2.h for sockaddr_storage

---
 configure.ac | 30 ++++++++++++++++++++++++------
 1 file changed, 24 insertions(+), 6 deletions(-)

diff --git a/configure.ac b/configure.ac
index faf9296..5283fe7 100644
--- a/configure.ac
+++ b/configure.ac
@@ -772,14 +772,32 @@ AC_CHECK_MEMBER(struct passwd.pw_gecos,
 [#include <pwd.h>])
 GIT_CONF_SUBST([NO_GECOS_IN_PWENT])
 #
+# Find Berkeley sockets headers, Windows uses winsock2.h
+# while others use sys/types.h and sys/socket.h
+POSIX_SOCKET_HEADERS=yes
+AC_CHECK_HEADERS([sys/types.h sys/socket.h],
+ [], [POSIX_SOCKET_HEADERS=no])
+WINDOWS_SOCKET_HEADERS=yes
+AC_CHECK_HEADERS([winsock2.h],
+ [], [WINDOWS_SOCKET_HEADERS=no])
+
+#
 # Define NO_SOCKADDR_STORAGE if your platform does not have struct
 # sockaddr_storage.
-AC_CHECK_TYPE(struct sockaddr_storage,
-[NO_SOCKADDR_STORAGE=],
-[NO_SOCKADDR_STORAGE=YesPlease],[
-#include <sys/types.h>
-#include <sys/socket.h>
-])
+AS_IF([test "x$POSIX_SOCKET_HEADERS" = "xyes"],
+ [AC_CHECK_TYPE(struct sockaddr_storage,
+  [NO_SOCKADDR_STORAGE=],
+  [NO_SOCKADDR_STORAGE=YesPlease],[
+  #include <sys/types.h>
+  #include <sys/socket.h>
+  ])],
+ [AS_IF([test "x$WINDOWS_SOCKET_HEADERS" = "xyes"],
+  [AC_CHECK_TYPE(struct sockaddr_storage,
+   [NO_SOCKADDR_STORAGE=],
+   [NO_SOCKADDR_STORAGE=YesPlease],[
+   #include <winsock2.h>
+   ])])]
+)
 GIT_CONF_SUBST([NO_SOCKADDR_STORAGE])
 #
 # Define NO_IPV6 if you lack IPv6 support and getaddrinfo().
-- 
2.0.1

